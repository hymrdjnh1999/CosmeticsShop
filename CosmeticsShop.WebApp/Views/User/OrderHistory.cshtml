@model List<Cosmetics.ViewModels.Catalogs.Orders.ClientOrderHistoryViewMode>;
@{
    ViewData["Title"] = "OrderHistory";
    Layout = "~/Views/Shared/_Layout.cshtml";

}

<div id="main">
    <div id="pageContainer">
        <main class="main_content" role="main">
            <div class="d-none rounded fixed-top justify-content-center" id="cancelMsgWrap">
                <span id="cancelMsg" class="rounded"></span>
            </div>
            <section id="page-wapper">
                <div class="wrapperAccount">
                    <div class="inner">
                        <div class="grid mg-left-110">
                            <div class="grid__item one-whole pd-left110">
                                <h2>Xin chào,</h2>
                                <h1>Test</h1>
                            </div>
                            <div class="grid__item one-quarter pd-left110">
                                <ul class="no-bullets">
                                    <li><a href="/user/detail">Thông tin tài khoản</a></li>
                                    <li><a href="#">Lịch sử đơn hàng</a></li>
                                </ul>
                            </div>
                            <div class="grid__item three-quarters pd-left110 br-right">
                                <div class="table-wrap table-order-customer">
                                    <table class="full">
                                        <thead>
                                            <tr>
                                                <th>Mã</th>
                                                <th>Ngày đặt</th>
                                                <th>Tổng tiền</th>
                                                <th>Tình trạng</th>
                                                <th>Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model)
                                            {
                                                <tr>
                                                    <td><a href="#">@item.Id</a></td>
                                                    <td>@item.OrderDate</td>
                                                    <td class="priceFormat">
                                                        @item.Total
                                                    </td>
                                                    <td class="orderStatus">@item.Status</td>
                                                    <td><span class="btn btn-danger cursor-pointer " onclick="openModal('order-modal','order-cancel-submit',@item.Id)">Hủy đơn</span></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="co-modal" id="order-modal">
                                <div class="co-modal--content ">
                                    <div class="co-modal--title px-3">
                                        Bạn có chắc chắn muốn hủy đơn hàng này chứ?
                                    </div>
                                    <div>
                                        <textarea rows="3" class="w-100 mt-4" style="outline:none;" placeholder="Điền lý do bạn muốn hủy đơn hàng này" id="orderCancelReason"></textarea>
                                        <span class="text-danger" id="cancelOrderReason"></span>
                                    </div>
                                    <div class="co-modal--btns">
                                        <span class="btn btn-outline-dark co-modal--btn co-cancel-btn" onclick="handleOnCancel()">Hủy bỏ</span>
                                        <span class="btn btn-outline-danger co-modal--btn co-submit-btn" id="order-cancel-submit" onclick="onSubmitCancelOrder(this)">Xác nhận</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

@section Scripts{
    <script>
        const onSubmitCancelOrder = (btnElement) => {
            const cancelReason = document.querySelector('#orderCancelReason').value;
            if (!cancelReason.trim()) {
                document.querySelector('#cancelOrderReason').innerText = "Không được để trống lý do";
                event.preventDefault();
                return;
            }
            const orderId = btnElement.getAttribute('data');
            if (orderId) {
                $.ajax({
                    method: 'PUT',
                    url: `/user/cancelOrder`,
                    dataType: 'text',
                    data: { orderId: Number(orderId), cancelReason },
                    async: true,
                    success: async function (response) {

                        const { isSuccess, message } = JSON.parse(response);
                        
                        $('#cancelMsgWrap').removeClass('d-none').addClass('d-flex');
                        if (isSuccess) {
                            $('#cancelMsg').html(message).addClass('rounded alert alert-success')
                        }
                        else {
                            $('#cancelMsg').html(message).addClass('rounded alert alert-danger')
                        }
                        await new Promise((resolve) => setTimeout(() => {
                            $('#cancelMsgWrap').fadeOut('slow');
                            resolve();
                        }, 1500));
                        $('#cancelMsg').html('')
                        $('#cancelMsgWrap').removeClass('d-flex').addClass('d-none');
                        handleOnCancel();
                    },
                    failure: function (response) {
                        alert('false')
                    },
                    error: function (response) {
                        alert('error')
                    }
                })
            }
        }
    </script>
}